{% load i18n %}

<c-vars session_id="" chat_enabled="true" />
<div x-data="chat"
     x-init="{% if session_id %}sessionId = '{{ session_id }}';{% endif %}"
     class="chat-window {{ class }}"
     {{ attrs }}>
  {# Messages container #}
  <div class="chat-messages"
       x-ref="messages"
       role="log"
       aria-live="polite"
       aria-label="{% trans "Chat messages" %}">
    {# All messages rendered dynamically via Alpine #}
    <template x-for="msg in dynamicMessages" :key="msg.id">
      <div class="chat-message"
           x-bind:class="'chat-message-' + msg.role"
           x-show="msg.content">
        <div class="chat-message-avatar">
          <template x-if="msg.role === 'user'">
            <c-atoms.icon name="user-circle" class="w-8 h-8 text-greyscale-400" />
          </template>
          <template x-if="msg.role === 'assistant'">
            <c-atoms.icon name="chat-bubble-left-right" class="w-8 h-8 text-primary-600" />
          </template>
        </div>
        <div class="chat-message-content">
          <div class="chat-bubble"
               x-bind:class="msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant'"
               x-html="msg.role === 'assistant' ? renderMarkdown(msg.content) : escapeHtml(msg.content)"></div>
        </div>
      </div>
    </template>
    {# Typing indicator #}
    <div x-show="isStreaming"
         x-cloak
         class="chat-message chat-message-assistant">
      <div class="chat-message-avatar">
        <c-atoms.icon name="chat-bubble-left-right" class="w-8 h-8 text-primary-600" />
      </div>
      <div class="chat-message-content">
        <c-atoms.typing-indicator />
      </div>
    </div>
  </div>
  {# Input form #}
  {% trans "Ask a legal question..." as chat_placeholder %}
  {% trans "Send message" as send_label %}
  <form x-on:submit.prevent="sendMessage"
        method="post"
        action="{% url 'chat:stream' %}"
        class="chat-input-form">
    {% csrf_token %}
    <c-atoms.input x-model="inputText" x-bind:disabled="isStreaming" type="text" name="message" placeholder="{{ chat_placeholder }}" aria_label="{{ chat_placeholder }}" class="flex-1" />
    <c-atoms.button type="submit" variant="primary" size="xl" x-bind:disabled="isStreaming || !inputText.trim()" aria_label="{{ send_label }}">
    <c-atoms.icon name="paper-airplane" class="w-5 h-5" />
    <span class="hidden sm:inline ml-2">{% trans "Send" %}</span>
    </c-atoms.button>
  </form>
  {# Fallback search link #}
  {% if not chat_enabled %}
    <div class="chat-fallback-notice">
      <p class="text-sm text-greyscale-600">
        {% trans "AI chat is currently unavailable." %}
        <c-atoms.link href="{% url 'chat:search' %}" variant="primary">{% trans "Use keyword search" %}</c-atoms.link>
      </p>
    </div>
  {% endif %}
</div>
